<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HP-Lab - HaterPicks Admin</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Inter:wght@400;500;600;700&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        :root {
            --primary-red: #7A1F29;
            --dark-red: #5C1720;
            --light-red: #9B2835;
            --accent-green: #22C55E;
            --accent-orange: #F59E0B;
            --bg-dark: #1A1A1A;
            --bg-card: #2A2A2A;
            --text-primary: #FFFFFF;
            --text-secondary: #9CA3AF;
            --border-color: #3A3A3A;
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #0F0F0F 100%);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        header {
            background: var(--primary-red);
            padding: 20px 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(122, 31, 41, 0.3);
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        h1 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 48px;
            letter-spacing: 2px;
        }
        
        .subtitle {
            font-size: 14px;
            opacity: 0.9;
            margin-top: -5px;
        }
        
        .logo {
            font-size: 36px;
        }
        
        .setup-card {
            background: var(--bg-card);
            padding: 30px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid var(--accent-green);
        }
        
        .setup-card h2 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 28px;
            color: var(--accent-green);
            margin-bottom: 15px;
        }
        
        .setup-step {
            background: var(--bg-dark);
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid var(--primary-red);
        }
        
        .setup-step h3 {
            color: var(--primary-red);
            margin-bottom: 10px;
            font-size: 18px;
        }
        
        .google-signin-btn {
            background: white;
            color: #444;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 10px;
            margin: 15px 0;
            transition: box-shadow 0.3s ease;
        }
        
        .google-signin-btn:hover {
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-indicator.connected {
            background: var(--accent-green);
            box-shadow: 0 0 10px var(--accent-green);
            animation: pulse 2s infinite;
        }
        
        .status-indicator.disconnected {
            background: #666;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .api-info {
            background: var(--bg-card);
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid var(--accent-orange);
        }
        
        .api-info h2 {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 24px;
            color: var(--accent-orange);
            margin-bottom: 15px;
        }
        
        .api-url {
            background: var(--bg-dark);
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 13px;
            color: var(--accent-green);
            margin: 10px 0;
            word-break: break-all;
        }
        
        input[type="text"] {
            width: 100%;
            padding: 12px 15px;
            background: var(--bg-dark);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            margin: 10px 0;
        }
        
        input[type="text"]:focus {
            outline: none;
            border-color: var(--primary-red);
        }
        
        button {
            padding: 12px 24px;
            background: var(--primary-red);
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }
        
        button:hover:not(:disabled) {
            background: var(--light-red);
            transform: translateY(-2px);
        }
        
        button:disabled {
            background: var(--border-color);
            cursor: not-allowed;
            transform: none;
        }
        
        .sync-status {
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 30px;
            border: 2px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .sync-info {
            flex: 1;
            min-width: 250px;
        }
        
        .sync-controls {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 10px;
        }

        .import-now-btn {
            background: var(--accent-green);
            color: #111;
            font-size: 18px;
            font-weight: 800;
            padding: 16px 36px;
            border-radius: 10px;
            border: none;
            cursor: pointer;
            letter-spacing: 0.5px;
            box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4);
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .import-now-btn:hover:not(:disabled) {
            background: #16a34a;
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(34, 197, 94, 0.5);
        }

        .import-now-btn:disabled {
            background: var(--border-color);
            color: #666;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .import-now-btn.syncing {
            animation: pulse-green 1s infinite;
        }

        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 4px 20px rgba(34, 197, 94, 0.4); }
            50%       { box-shadow: 0 4px 30px rgba(34, 197, 94, 0.8); }
        }

        .secondary-controls {
            display: flex;
            gap: 8px;
        }

        .secondary-btn {
            background: var(--bg-card);
            color: var(--text-secondary);
            border: 2px solid var(--border-color);
            font-size: 13px;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: 600;
        }

        .secondary-btn:hover {
            border-color: var(--primary-red);
            color: var(--text-primary);
            transform: none;
        }

        .danger-btn {
            background: var(--bg-card);
            color: #EF4444;
            border-color: #EF4444;
        }

        .danger-btn:hover {
            background: #EF4444;
            color: white;
            border-color: #EF4444;
        }
        
        .stats-bar {
            display: flex;
            gap: 20px;
            background: var(--bg-card);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 2px solid var(--border-color);
            flex-wrap: wrap;
        }
        
        .stat {
            flex: 1;
            text-align: center;
            min-width: 120px;
        }
        
        .stat-value {
            font-family: 'Bebas Neue', sans-serif;
            font-size: 32px;
            color: var(--primary-red);
        }
        
        .stat-label {
            font-size: 12px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 5px;
        }
        
        .bets-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .bet-card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 20px;
            border: 2px solid var(--border-color);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .bet-card:hover {
            border-color: var(--primary-red);
            transform: translateY(-2px);
        }
        
        .bet-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: var(--accent-green);
        }
        
        .bet-card.arbitrage::before {
            background: var(--accent-orange);
        }
        
        .bet-type {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            margin-bottom: 12px;
        }
        
        .bet-type.positive-ev {
            background: rgba(34, 197, 94, 0.2);
            color: var(--accent-green);
        }
        
        .bet-type.arbitrage {
            background: rgba(245, 158, 11, 0.2);
            color: var(--accent-orange);
        }
        
        .bet-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }
        
        .bet-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 15px;
        }
        
        .bet-detail {
            background: var(--bg-dark);
            padding: 10px;
            border-radius: 6px;
        }
        
        .bet-detail-label {
            font-size: 11px;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .bet-detail-value {
            font-size: 16px;
            font-weight: 700;
        }
        
        .success {
            background: rgba(34, 197, 94, 0.1);
            border: 2px solid var(--accent-green);
            color: var(--accent-green);
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .error {
            background: rgba(239, 68, 68, 0.1);
            border: 2px solid #EF4444;
            color: #FCA5A5;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
        }
        
        .spinner {
            border: 4px solid var(--border-color);
            border-top: 4px solid var(--primary-red);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none !important;
        }
        
        .info-box {
            background: rgba(34, 197, 94, 0.1);
            border-left: 4px solid var(--accent-green);
            padding: 15px;
            margin: 15px 0;
            border-radius: 4px;
        }
        
        .info-box p {
            font-size: 13px;
            line-height: 1.6;
        }
        
        @media (max-width: 768px) {
            h1 {
                font-size: 36px;
            }
            
            .bets-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-bar {
                flex-direction: column;
            }
            
            .sync-status {
                flex-direction: column;
            }
            
            .header-content {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="header-content">
                <div>
                    <h1>HP-LAB</h1>
                    <div class="subtitle">Auto-Sync from Google Drive CSV</div>
                </div>
                <div class="logo">üìä</div>
            </div>
        </header>
        
        <!-- Setup Instructions -->
        <div id="setupSection" class="setup-card">
            <h2>üöÄ Quick Setup</h2>
            
            <div class="setup-step">
                <h3>Step 1: Connect Google Drive</h3>
                <p style="color: var(--text-secondary); margin-bottom: 15px;">
                    Authorize HP-Lab to read your CSV files from Google Drive.
                </p>
                <button class="google-signin-btn" onclick="handleAuthClick()" id="authButton">
                    <svg width="20" height="20" viewBox="0 0 48 48">
                        <path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/>
                        <path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/>
                        <path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/>
                        <path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/>
                    </svg>
                    Sign in with Google
                </button>
            </div>
            
            <div class="setup-step">
                <h3>Step 2: Enter Google Drive Folder ID</h3>
                <p style="color: var(--text-secondary); margin-bottom: 10px;">
                    Create a folder in Google Drive and drop all your exported CSVs into it.
                    HP-Lab will always read the most recently modified CSV automatically.
                </p>
                <div class="info-box">
                    <p><strong>How to get your Folder ID:</strong></p>
                    <p>1. Open Google Drive and create a folder e.g. "HaterPicks Lab"</p>
                    <p>2. Open the folder ‚Äî look at the URL in your browser</p>
                    <p>3. The URL looks like: drive.google.com/drive/folders/<strong>1abc123xyz</strong></p>
                    <p>4. Copy the ID at the end (the bold part above)</p>
                    <p>5. Make sure the folder is shared as "Anyone with the link"</p>
                </div>
                <input 
                    type="text" 
                    id="fileIdInput" 
                    placeholder="Paste full Google Drive folder URL or just the Folder ID"
                    disabled
                />
                <button id="saveFileIdBtn" onclick="saveFileId()" disabled>Save & Start Syncing</button>
            </div>
            
            <div class="setup-step">
                <h3>Step 3: Configure Auto-Sync</h3>
                <p style="color: var(--text-secondary); margin-bottom: 10px;">
                    How often should HP-Lab check for CSV updates?
                </p>
                <select id="syncInterval" style="width: 100%; padding: 12px; background: var(--bg-dark); color: white; border: 2px solid var(--border-color); border-radius: 8px; margin: 10px 0;">
                    <option value="60">Every 1 minute (testing)</option>
                    <option value="300" selected>Every 5 minutes (recommended)</option>
                    <option value="600">Every 10 minutes</option>
                    <option value="900">Every 15 minutes</option>
                    <option value="1800">Every 30 minutes</option>
                </select>
            </div>
        </div>
        
        <!-- Sync Dashboard -->
        <div id="syncSection" class="hidden">
            <div class="sync-status">
                <div class="sync-info">
                    <div style="display: flex; align-items: center; margin-bottom: 10px;">
                        <span class="status-indicator" id="statusIndicator"></span>
                        <span style="font-weight: 600; font-size: 16px;" id="statusText">Initializing...</span>
                    </div>
                    <div style="font-size: 13px; color: var(--text-secondary); line-height: 1.8;">
                        <div>üìÅ Folder: <span id="currentFileName">Not set</span></div>
                        <div>üîÑ Last sync: <span id="lastSyncTime">Never</span></div>
                        <div>‚è±Ô∏è Next sync: <span id="nextSyncTime">-</span></div>
                        <div>üìä Sync interval: <span id="syncIntervalDisplay">5 minutes</span></div>
                    </div>
                </div>
                <div class="sync-controls">
                    <button onclick="manualSync()" id="syncNowBtn" class="import-now-btn">
                        ‚ö° Import Now
                    </button>
                    <div class="secondary-controls">
                        <button onclick="testDriveAccess()" class="secondary-btn" style="border-color: var(--accent-orange); color: var(--accent-orange);">üîç Test Drive Access</button>
                        <button onclick="toggleAutoSync()" id="toggleSyncBtn" class="secondary-btn">‚è∏ Pause Auto</button>
                        <button onclick="disconnect()" class="secondary-btn danger-btn">‚úï Disconnect</button>
                    </div>
                </div>
            </div>
            
            <div class="api-info">
                <h2>üì° Base44 API Endpoint</h2>
                <p style="margin-bottom: 10px; font-size: 14px;">Use this URL in your Base44 app to fetch betting data:</p>
                <div class="api-url" id="apiEndpoint">Loading...</div>
                <button onclick="copyApiUrl()">üìã Copy API URL</button>
                <p style="margin-top: 15px; font-size: 12px; color: var(--text-secondary);">
                    üí° Make a GET request to this URL in Base44 to receive all bets as JSON.
                </p>
            </div>
            
            <div class="stats-bar" id="statsBar">
                <div class="stat">
                    <div class="stat-value" id="totalBets">0</div>
                    <div class="stat-label">Total Bets</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="positiveEvCount">0</div>
                    <div class="stat-label">Positive EV</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="arbitrageCount">0</div>
                    <div class="stat-label">Arbitrage</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="avgEv">0%</div>
                    <div class="stat-label">Avg EV</div>
                </div>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="font-family: 'Bebas Neue', sans-serif; font-size: 32px;">Current Bets</h2>
                <button onclick="loadBets()" style="background: var(--accent-green);">üîÑ Refresh View</button>
            </div>
            <div id="betsContainer" class="bets-grid"></div>
        </div>
    </div>
    
    <!-- Google API -->
    <script src="https://apis.google.com/js/api.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getFirestore } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        
        // TODO: Replace with your Firebase config from Firebase Console
        const firebaseConfig = {
            apiKey: "AIzaSyBTD_wOtcmwHZUi1upRE89gv5A7hTHJrAA",
            authDomain: "hp-lab-37090.firebaseapp.com",
            projectId: "hp-lab-37090",
            storageBucket: "hp-lab-37090.firebasestorage.app",
            messagingSenderId: "505777325542",
            appId: "1:505777325542:web:df5a38417198dd36718227"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.db = db;
        window.firebaseConfig = firebaseConfig;
        
        // Set API endpoint
        const apiUrl = `https://firestore.googleapis.com/v1/projects/${firebaseConfig.projectId}/databases/(default)/documents/bets`;
        document.getElementById('apiEndpoint').textContent = apiUrl;
    </script>
    
    <script>
        const CLIENT_ID = '505777325542-2ji9hev1umil4qi18hrccqe3noglie4t.apps.googleusercontent.com';
        const API_KEY = 'AIzaSyBTD_wOtcmwHZUi1upRE89gv5A7hTHJrAA';
        const SCOPES = 'https://www.googleapis.com/auth/drive.readonly https://www.googleapis.com/auth/drive.metadata.readonly';

        let accessToken = null;
        let syncIntervalId;
        let isAutoSyncing = true;

        // ‚îÄ‚îÄ OAuth2 via popup ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        function handleAuthClick() {
            const authUrl =
                'https://accounts.google.com/o/oauth2/v2/auth' +
                '?client_id=' + encodeURIComponent(CLIENT_ID) +
                '&redirect_uri=' + encodeURIComponent('https://haterpicks.github.io/hp-lab/') +
                '&response_type=token' +
                '&scope=' + encodeURIComponent(SCOPES) +
                '&prompt=consent';

            // Open popup
            const w = 500, h = 600;
            const left = window.screenX + (window.outerWidth  - w) / 2;
            const top  = window.screenY + (window.outerHeight - h) / 2;
            const popup = window.open(authUrl, 'googleAuth',
                'width=' + w + ',height=' + h + ',left=' + left + ',top=' + top);

            // Poll until popup redirects back with token
            const poll = setInterval(function() {
                try {
                    if (!popup || popup.closed) {
                        clearInterval(poll);
                        return;
                    }
                    const href = popup.location.href;
                    if (href && href.indexOf('https://haterpicks.github.io') === 0) {
                        clearInterval(poll);
                        popup.close();

                        // Extract access_token from hash fragment
                        const hash = popup.location.hash || href.split('#')[1] || '';
                        const params = {};
                        hash.replace(/^#/, '').split('&').forEach(function(p) {
                            const parts = p.split('=');
                            params[decodeURIComponent(parts[0])] = decodeURIComponent(parts[1] || '');
                        });

                        if (params.access_token) {
                            accessToken = params.access_token;
                            onAuthSuccess();
                        } else {
                            showError('Sign-in failed. Please try again.');
                        }
                    }
                } catch (e) {
                    // Cross-origin ‚Äî still waiting
                }
            }, 300);
        }

        function onAuthSuccess() {
            document.getElementById('fileIdInput').disabled = false;
            document.getElementById('saveFileIdBtn').disabled = false;
            showSuccess('‚úì Connected to Google Drive! Now enter your CSV File ID.');

            const savedFileId = localStorage.getItem('hplab_fileId');
            if (savedFileId) {
                document.getElementById('fileIdInput').value = savedFileId;
                showSyncSection();
                startAutoSync();
            }
        }
        
        // Save File ID ‚Äî strips full URLs down to just the ID automatically
        function saveFileId() {
            let input = document.getElementById('fileIdInput').value.trim();

            if (!input) {
                showError('Please enter a Folder ID or URL');
                return;
            }

            // If user pasted a full Google Drive URL, extract just the folder ID
            // Handles: https://drive.google.com/drive/folders/FOLDER_ID
            //          https://drive.google.com/drive/folders/FOLDER_ID?usp=sharing
            const folderMatch = input.match(/folders\/([a-zA-Z0-9_-]+)/);
            if (folderMatch) {
                input = folderMatch[1];
                showSuccess('‚úì Extracted Folder ID: ' + input);
            }

            if (input.length < 10) {
                showError('Folder ID seems too short. Please check and try again.');
                return;
            }

            localStorage.setItem('hplab_fileId', input);
            localStorage.setItem('hplab_syncInterval', document.getElementById('syncInterval').value);

            showSuccess('‚úì Folder ID saved! Starting auto-sync...');
            showSyncSection();
            startAutoSync();
        }
        
        // Show sync section
        function showSyncSection() {
            document.getElementById('setupSection').classList.add('hidden');
            document.getElementById('syncSection').classList.remove('hidden');
            
            const fileId = localStorage.getItem('hplab_fileId');
            const interval = localStorage.getItem('hplab_syncInterval') || '300';
            
            document.getElementById('currentFileName').textContent = fileId.substring(0, 25) + '...';
            document.getElementById('syncIntervalDisplay').textContent = formatInterval(parseInt(interval));
            
            updateStatus('connected', '‚úì Connected & Syncing');
        }
        
        // Format interval for display
        function formatInterval(seconds) {
            if (seconds < 60) return seconds + ' seconds';
            if (seconds < 3600) return (seconds / 60) + ' minutes';
            return (seconds / 3600) + ' hours';
        }
        
        // Manual sync ‚Äî triggered by Import Now button
        async function manualSync() {
            const btn = document.getElementById('syncNowBtn');
            btn.disabled = true;
            btn.textContent = '‚è≥ Importing...';
            btn.classList.add('syncing');

            await syncFromDrive();

            btn.disabled = false;
            btn.textContent = '‚ö° Import Now';
            btn.classList.remove('syncing');
        }
        
        // Test Drive API access - shows raw response so user can diagnose
        async function testDriveAccess() {
            if (!accessToken) { showError('Please sign in first.'); return; }
            const folderId = localStorage.getItem('hplab_fileId');

            showSuccess('Testing Drive API access... check console (Cmd+Option+J) for details.');

            // Test 1: about
            const a = await fetch('https://www.googleapis.com/drive/v3/about?fields=user',
                { headers: { 'Authorization': 'Bearer ' + accessToken } });
            const aData = await a.text();
            console.log('TEST 1 - About API status:', a.status);
            console.log('TEST 1 - About API response:', aData);

            if (a.status !== 200) {
                showError('Drive API not accessible (status ' + a.status + '). Check Google Drive API is enabled in Google Cloud Console ‚Üí APIs & Services ‚Üí Enabled APIs.');
                return;
            }
            showSuccess('‚úì Drive API works. Now testing folder access...');

            // Test 2: folder
            if (folderId) {
                const q = encodeURIComponent("'" + folderId + "' in parents and trashed = false");
                const f = await fetch(
                    'https://www.googleapis.com/drive/v3/files?q=' + q + '&pageSize=5&fields=files(id,name,mimeType)',
                    { headers: { 'Authorization': 'Bearer ' + accessToken } }
                );
                const fData = await f.text();
                console.log('TEST 2 - Folder API status:', f.status);
                console.log('TEST 2 - Folder API response:', fData);

                if (f.status === 200) {
                    const parsed = JSON.parse(fData);
                    const count = (parsed.files || []).length;
                    showSuccess('‚úì Folder accessible! Found ' + count + ' file(s). ' + (count === 0 ? 'Upload a CSV to the folder.' : 'Ready to sync!'));
                } else {
                    showError('Folder error ' + f.status + '. Response: ' + fData.substring(0, 200));
                }
            }
        }

        // Find most recent CSV in folder, then read it
        async function syncFromDrive() {
            const folderId = localStorage.getItem('hplab_fileId');
            if (!folderId) { showError('No Folder ID configured'); return; }
            if (!accessToken) { showError('Not signed in to Google. Please sign in first.'); return; }

            try {
                updateStatus('syncing', '‚è≥ Connecting to Google Drive...');

                // Step 1: verify token works with a simple 'about' call
                const aboutResp = await fetch(
                    'https://www.googleapis.com/drive/v3/about?fields=user',
                    { headers: { 'Authorization': 'Bearer ' + accessToken } }
                );
                if (aboutResp.status === 401) {
                    accessToken = null;
                    document.getElementById('setupSection').classList.remove('hidden');
                    document.getElementById('syncSection').classList.add('hidden');
                    showError('Google session expired ‚Äî please sign in again.');
                    return;
                }
                if (!aboutResp.ok) {
                    throw new Error('Google Drive API error ' + aboutResp.status + '. Make sure Google Drive API is enabled in Google Cloud Console.');
                }

                updateStatus('syncing', '‚è≥ Reading folder...');

                // Step 2: list files in folder
                const q = encodeURIComponent("'" + folderId + "' in parents and trashed = false");
                const listUrl = 'https://www.googleapis.com/drive/v3/files?q=' + q
                    + '&orderBy=modifiedTime+desc&pageSize=20'
                    + '&fields=files(id,name,mimeType,modifiedTime)'
                    + '&supportsAllDrives=true&includeItemsFromAllDrives=true';

                const listResp = await fetch(listUrl, {
                    headers: { 'Authorization': 'Bearer ' + accessToken }
                });

                if (listResp.status === 404) {
                    throw new Error(
                        'Folder not found (404). Please check:\n' +
                        '1. The Folder ID is correct (copy from the URL when folder is open)\n' +
                        '2. The folder is shared as Anyone with the link\n' +
                        '3. Your Folder ID: ' + folderId
                    );
                }
                if (!listResp.ok) {
                    const t = await listResp.text();
                    throw new Error('Could not list folder (' + listResp.status + '): ' + t.substring(0, 150));
                }

                const listData = await listResp.json();
                console.log('Folder contents:', listData);

                const allFiles = listData.files || [];
                if (allFiles.length === 0) {
                    throw new Error('Folder is empty. Drop a CSV file into the folder first.');
                }

                // Step 3: pick latest CSV
                const csvFiles = allFiles.filter(f =>
                    f.name.toLowerCase().endsWith('.csv') ||
                    f.mimeType === 'text/csv' ||
                    f.mimeType === 'text/plain'
                );

                if (csvFiles.length === 0) {
                    const names = allFiles.map(f => f.name).join(', ');
                    throw new Error('No CSV files found. Files in folder: ' + names);
                }

                const latest = csvFiles[0];
                updateStatus('syncing', '‚è≥ Reading: ' + latest.name);

                // Step 4: download it
                const fileResp = await fetch(
                    'https://www.googleapis.com/drive/v3/files/' + latest.id + '?alt=media',
                    { headers: { 'Authorization': 'Bearer ' + accessToken } }
                );
                if (!fileResp.ok) {
                    throw new Error('Could not download ' + latest.name + ' (' + fileResp.status + ')');
                }

                const csvText = await fileResp.text();
                const bets    = parseCSV(csvText);

                if (bets.length === 0) {
                    throw new Error('No valid bets in ' + latest.name + '. Check it has the correct columns.');
                }

                await saveBetsToFirebase(bets);
                await loadBets();

                const now      = new Date();
                const modified = new Date(latest.modifiedTime).toLocaleString();
                document.getElementById('lastSyncTime').textContent    = now.toLocaleTimeString();
                document.getElementById('currentFileName').textContent = latest.name + ' ‚Äî modified ' + modified;

                const interval = parseInt(localStorage.getItem('hplab_syncInterval') || '300');
                document.getElementById('nextSyncTime').textContent =
                    new Date(now.getTime() + interval * 1000).toLocaleTimeString();

                updateStatus('connected', '‚úì Connected & Syncing');
                showSuccess('‚úì Synced ' + bets.length + ' bets from ' + latest.name);

            } catch (error) {
                console.error('Sync error:', error);
                updateStatus('error', '‚ö†Ô∏è Sync failed');
                showError(error.message);
            }
        }
        
        // Start auto-sync
        function startAutoSync() {
            const interval = parseInt(localStorage.getItem('hplab_syncInterval') || '300') * 1000;
            
            // Initial sync
            syncFromDrive();
            
            // Set up interval
            if (syncIntervalId) clearInterval(syncIntervalId);
            syncIntervalId = setInterval(syncFromDrive, interval);
            
            isAutoSyncing = true;
            document.getElementById('toggleSyncBtn').textContent = 'Pause';
            
            // Update next sync time display
            updateNextSyncTime();
            setInterval(updateNextSyncTime, 1000);
        }
        
        // Update next sync countdown
        function updateNextSyncTime() {
            if (!isAutoSyncing) return;
            
            const lastSyncText = document.getElementById('lastSyncTime').textContent;
            if (lastSyncText === 'Never') return;
            
            const interval = parseInt(localStorage.getItem('hplab_syncInterval') || '300');
            // This is simplified - in production you'd track actual last sync timestamp
        }
        
        // Toggle auto-sync
        function toggleAutoSync() {
            const btn = document.getElementById('toggleSyncBtn');
            if (isAutoSyncing) {
                clearInterval(syncIntervalId);
                isAutoSyncing = false;
                btn.textContent = '‚ñ∂ Resume Auto';
                btn.style.borderColor = 'var(--accent-green)';
                btn.style.color = 'var(--accent-green)';
                updateStatus('paused', '‚è∏Ô∏è Auto-sync paused ‚Äî use Import Now to sync manually');
                showSuccess('Auto-sync paused. Hit ‚ö° Import Now to sync immediately.');
            } else {
                btn.textContent = '‚è∏ Pause Auto';
                btn.style.borderColor = '';
                btn.style.color = '';
                startAutoSync();
                showSuccess('Auto-sync resumed.');
            }
        }
        
        // Disconnect
        function disconnect() {
            if (!confirm('Disconnect from Google Drive? You will need to sign in again.')) {
                return;
            }

            clearInterval(syncIntervalId);
            localStorage.removeItem('hplab_fileId');
            localStorage.removeItem('hplab_syncInterval');
            accessToken = null;

            document.getElementById('setupSection').classList.remove('hidden');
            document.getElementById('syncSection').classList.add('hidden');
            document.getElementById('fileIdInput').value = '';
            document.getElementById('fileIdInput').disabled = true;
            document.getElementById('saveFileIdBtn').disabled = true;

            showSuccess('Disconnected successfully');
        }
        
        // Update status indicator
        function updateStatus(status, text) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            indicator.className = 'status-indicator';
            
            if (status === 'connected' || status === 'syncing') {
                indicator.classList.add('connected');
            } else {
                indicator.classList.add('disconnected');
            }
            
            statusText.textContent = text;
        }
        
        // Parse CSV - supports both custom format and bet-tracker export format
        function parseCSV(csv) {
            const lines = csv.split('\n').filter(line => line.trim());
            if (lines.length === 0) {
                throw new Error('CSV file is empty');
            }
            
            const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
            const bets = [];
            
            // Detect if this is a bet-tracker export
            const isBetTracker = headers.includes('game date') || headers.includes('selection');
            
            for (let i = 1; i < lines.length; i++) {
                const values = lines[i].split(',').map(v => v.trim());
                const bet = {};
                
                headers.forEach((header, index) => {
                    bet[header] = values[index] || '';
                });
                
                let parsedBet;
                
                if (isBetTracker) {
                    // Bet-tracker export format
                    // Determine type based on Tags field
                    let betType = 'positive-ev'; // default
                    const tags = (bet.tags || '').toLowerCase();
                    if (tags.includes('arb') || tags.includes('arbitrage')) {
                        betType = 'arbitrage';
                    } else if (tags.includes('benchmark') || tags.includes('ev')) {
                        betType = 'positive-ev';
                    }
                    
                    // Calculate EV or profit based on Status and P/L
                    const status = (bet.status || '').toLowerCase();
                    const pl = parseFloat((bet['p/l ($)'] || bet['p/l'] || '0').replace(/[^0-9.-]/g, '')) || 0;
                    const stakeValue = parseFloat((bet['stake ($)'] || bet.stake || '0').replace(/[^0-9.-]/g, '')) || 0;
                    
                    let ev = 0;
                    let profit = 0;
                    
                    if (betType === 'arbitrage') {
                        profit = pl;
                    } else {
                        // Calculate EV as percentage
                        if (stakeValue > 0) {
                            ev = ((pl / stakeValue) * 100).toFixed(2);
                        }
                    }
                    
                    parsedBet = {
                        type: betType,
                        title: `${bet.match || bet.game || 'Unknown Match'}`,
                        market: `${bet.market || ''} - ${bet.selection || ''}`,
                        odds: parseFloat(bet.odds) || 0,
                        stake: stakeValue,
                        bookmaker: bet.bookmaker || 'Unknown',
                        ev: parseFloat(ev),
                        profit: profit,
                        notes: bet.notes || '',
                        sport: bet.sport || '',
                        league: bet.league || '',
                        status: status,
                        timestamp: new Date().toISOString()
                    };
                } else {
                    // Original custom format
                    parsedBet = {
                        type: bet.type,
                        title: bet.title,
                        market: bet.market || '',
                        odds: parseFloat(bet.odds || bet.decimal_odds) || 0,
                        stake: parseFloat(bet.stake || bet.recommended_stake) || 0,
                        bookmaker: bet.bookmaker || bet.sportsbook,
                        ev: parseFloat(bet.ev || bet.expected_value) || 0,
                        profit: parseFloat(bet.profit || bet.potential_profit) || 0,
                        notes: bet.notes || '',
                        timestamp: new Date().toISOString()
                    };
                }
                
                // Validate required fields
                if (parsedBet.title && parsedBet.odds && parsedBet.bookmaker) {
                    bets.push(parsedBet);
                }
            }
            
            return bets;
        }
        
        // Save to Firebase
        async function saveBetsToFirebase(bets) {
            const { collection, getDocs, doc, setDoc, deleteDoc } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js');
            
            // Clear existing bets
            const querySnapshot = await getDocs(collection(window.db, 'bets'));
            const deletePromises = [];
            querySnapshot.forEach((document) => {
                deletePromises.push(deleteDoc(doc(window.db, 'bets', document.id)));
            });
            await Promise.all(deletePromises);
            
            // Add new bets
            for (let i = 0; i < bets.length; i++) {
                await setDoc(doc(window.db, 'bets', `bet_${Date.now()}_${i}`), bets[i]);
            }
        }
        
        // Load and display bets
        async function loadBets() {
            const { collection, getDocs } = await import('https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js');
            
            const container = document.getElementById('betsContainer');
            container.innerHTML = '<div class="spinner"></div>';
            
            try {
                const querySnapshot = await getDocs(collection(window.db, 'bets'));
                const bets = [];
                
                querySnapshot.forEach((doc) => {
                    bets.push({ id: doc.id, ...doc.data() });
                });
                
                if (bets.length === 0) {
                    container.innerHTML = '<p style="text-align: center; color: var(--text-secondary); padding: 40px; grid-column: 1/-1;">No bets yet. Waiting for first sync...</p>';
                    return;
                }
                
                // Update stats
                let positiveEvCount = 0;
                let arbitrageCount = 0;
                let totalEv = 0;
                
                bets.forEach(bet => {
                    const type = (bet.type || '').toLowerCase();
                    if (type.includes('ev') || type.includes('positive')) {
                        positiveEvCount++;
                        totalEv += parseFloat(bet.ev || 0);
                    } else if (type.includes('arb')) {
                        arbitrageCount++;
                    }
                });
                
                document.getElementById('totalBets').textContent = bets.length;
                document.getElementById('positiveEvCount').textContent = positiveEvCount;
                document.getElementById('arbitrageCount').textContent = arbitrageCount;
                document.getElementById('avgEv').textContent = positiveEvCount > 0 
                    ? `${(totalEv / positiveEvCount).toFixed(2)}%` 
                    : '0%';
                
                // Render bets
                container.innerHTML = '';
                bets.forEach(bet => {
                    container.appendChild(createBetCard(bet));
                });
                
            } catch (error) {
                container.innerHTML = `<p style="color: #EF4444; grid-column: 1/-1; text-align: center; padding: 40px;">Error loading bets: ${error.message}</p>`;
            }
        }
        
        // Create bet card
        function createBetCard(bet) {
            const card = document.createElement('div');
            const isArbitrage = (bet.type || '').toLowerCase().includes('arb');
            
            // Determine if this is a completed bet (has status)
            const status = bet.status || '';
            const isCompleted = status.toLowerCase() === 'win' || status.toLowerCase() === 'loss';
            
            card.className = `bet-card ${isArbitrage ? 'arbitrage' : 'positive-ev'}`;
            
            // Build sport/league badge if available
            let sportBadge = '';
            if (bet.sport || bet.league) {
                sportBadge = `<div style="font-size: 11px; color: var(--text-secondary); margin-bottom: 8px;">
                    ${bet.sport ? `<span style="background: var(--bg-dark); padding: 3px 8px; border-radius: 3px; margin-right: 5px;">${bet.sport}</span>` : ''}
                    ${bet.league ? `<span style="background: var(--bg-dark); padding: 3px 8px; border-radius: 3px;">${bet.league}</span>` : ''}
                </div>`;
            }
            
            // Build status badge if completed
            let statusBadge = '';
            if (isCompleted) {
                const statusColor = status.toLowerCase() === 'win' ? 'var(--accent-green)' : '#EF4444';
                statusBadge = `<span style="float: right; background: ${statusColor}; color: white; padding: 3px 10px; border-radius: 12px; font-size: 10px; font-weight: 700;">${status.toUpperCase()}</span>`;
            }
            
            card.innerHTML = `
                <span class="bet-type ${isArbitrage ? 'arbitrage' : 'positive-ev'}">
                    ${isArbitrage ? 'Arbitrage' : 'Positive EV'}
                </span>
                ${statusBadge}
                <div style="clear: both;"></div>
                ${sportBadge}
                <div class="bet-title">${bet.title}</div>
                ${bet.market ? `<div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">${bet.market}</div>` : ''}
                <div class="bet-details">
                    <div class="bet-detail">
                        <div class="bet-detail-label">Odds</div>
                        <div class="bet-detail-value">${bet.odds}</div>
                    </div>
                    <div class="bet-detail">
                        <div class="bet-detail-label">Stake</div>
                        <div class="bet-detail-value">$${bet.stake || 0}</div>
                    </div>
                    <div class="bet-detail">
                        <div class="bet-detail-label">${isArbitrage ? 'Profit' : 'EV'}</div>
                        <div class="bet-detail-value" style="color: ${isArbitrage ? 'var(--accent-orange)' : 'var(--accent-green)'}">
                            ${isArbitrage ? `$${bet.profit}` : `${bet.ev}%`}
                        </div>
                    </div>
                    <div class="bet-detail">
                        <div class="bet-detail-label">Book</div>
                        <div class="bet-detail-value" style="font-size: 13px;">${bet.bookmaker}</div>
                    </div>
                </div>
                ${bet.notes ? `<div style="margin-top: 12px; font-size: 12px; color: var(--text-secondary); font-style: italic;">${bet.notes}</div>` : ''}
            `;
            
            return card;
        }
        
        // Copy API URL
        function copyApiUrl() {
            const url = document.getElementById('apiEndpoint').textContent;
            navigator.clipboard.writeText(url).then(() => {
                showSuccess('‚úì API URL copied to clipboard!');
            }).catch(() => {
                showError('Failed to copy. Please copy manually.');
            });
        }
        
        // Show messages
        function showSuccess(message) {
            const div = document.createElement('div');
            div.className = 'success';
            div.textContent = message;
            const container = document.querySelector('.container');
            container.insertBefore(div, container.firstChild);
            setTimeout(() => div.remove(), 5000);
        }
        
        function showError(message) {
            const div = document.createElement('div');
            div.className = 'error';
            div.textContent = message;
            const container = document.querySelector('.container');
            container.insertBefore(div, container.firstChild);
            setTimeout(() => div.remove(), 7000);
        }
        
        // Initialize on load
        window.onload = function() {
            // Load gapi for Drive discovery (not needed for auth anymore)
            if (window.gapi) {
                gapi.load('client', function() {
                    gapi.client.init({ apiKey: API_KEY });
                });
            }
            // Note: access token not persisted across page loads
            // User must sign in each session - this is normal for OAuth implicit flow
        };
    </script>
</body>
</html>
